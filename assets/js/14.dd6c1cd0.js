(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{210:function(s,n,t){s.exports=t.p+"assets/img/sentinel.ea94b5e4.png"},211:function(s,n,t){s.exports=t.p+"assets/img/image-20210311164903085.c7a3b3ef.png"},212:function(s,n,t){s.exports=t.p+"assets/img/image-20210311165908741.519f23c8.png"},315:function(s,n,t){"use strict";t.r(n);var e=[function(){var s=this,n=s._self._c;return n("div",{staticClass:"content"},[n("h1",{attrs:{id:"哨兵机制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#哨兵机制"}},[s._v("#")]),s._v(" 哨兵机制")]),s._v(" "),n("p",[n("img",{attrs:{src:t(210),alt:"sentinel"}})]),s._v(" "),n("p",[s._v("Sentinel（哨兵）是Redis的"),n("strong",[s._v("高可用性")]),s._v("的解决方案，由一个或多个Sentinel实例组成的Sentinel系统可以监视任意多个主服务器以及属下的所有从服务器。当主服务器下线时，自动将下线的某个主服务器属下的某个从服务器"),n("strong",[s._v("升级")]),s._v("为新的主服务器。从而实现"),n("strong",[s._v("故障转移")]),s._v("，当原来的主服务器重新上线时，会被降级为从服务器。")]),s._v(" "),n("p",[s._v("下面展示了哨兵监视主从的状态：")]),s._v(" "),n("p",[n("img",{attrs:{src:t(211),alt:"image-20210311164903085"}})]),s._v(" "),n("p",[s._v("下面主要讲解Sentinel系统对主服务器执行故障转移的整个过程。")]),s._v(" "),n("h2",{attrs:{id:"启动并初始化sentinel"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#启动并初始化sentinel"}},[s._v("#")]),s._v(" "),n("strong",[s._v("启动并初始化Sentinel")])]),s._v(" "),n("p",[s._v("启动Sentinel有两种方式：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("redis-sentinel /path/to/your/sentinel.conf")])]),s._v(" "),n("li",[n("code",[s._v("redis-server /path/to/your/sentinel.conf --sentinel")])])]),s._v(" "),n("p",[s._v("俩命令效果相同，启动时需要执行以下步骤：")]),s._v(" "),n("ol",[n("li",[s._v("初始化服务器。")]),s._v(" "),n("li",[s._v("将普通Redis服务器使用的代码替换成Sentinel专用代码。")]),s._v(" "),n("li",[s._v("初始化Sentinel状态。")]),s._v(" "),n("li",[s._v("根据配置文件，初始化Sentinel的监视主服务器列表。")]),s._v(" "),n("li",[s._v("创建连向主服务器的网络连接。")])]),s._v(" "),n("p",[n("strong",[s._v("初始化服务器")])]),s._v(" "),n("p",[s._v("Sentinel实际上是一个特殊的Redis服务器，所以很多地方和Redis服务器的初始化有些类似。只不过少了RDB或AOF文件的载入等操作。")]),s._v(" "),n("p",[n("strong",[s._v("使用Sentinel专用代码")])]),s._v(" "),n("p",[s._v("将加载的常量，命令表（决定了Sentinel可以执行哪些命令）等替换为Sentinel专用的。")]),s._v(" "),n("p",[n("strong",[s._v("初始化Sentinel状态")])]),s._v(" "),n("p",[s._v("初始化一个"),n("code",[s._v("sentinel.c/sentinelState")]),s._v("结构，记录Sentinel的状态，保存了服务器中所有与Sentinel相关的状态：")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sentinelState")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//当前纪元，选举计数器，用于实现故障转移")]),s._v("\n    uint64_ t current_ epoch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//（重点）保存了所有被这个sentinel监视的主服务器")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//字典的键是主服务器的名字，值是一个指向sentine1RedisInstance结构的指针")]),s._v("\n    dict masters"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//是否进入了TILT模式")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" tilt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//目前正在执行的脚本的数量")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" running_ scripts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//进入TILT模式的时间")]),s._v("\n    mstime_ _t tilt_ start_ time"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//最后一次执行时间处理器的时间")]),s._v("\n    mstime_ t previous_ time "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//一个FIFO队列，包含了所有需要执行的用户脚本")]),s._v("\n    list "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("scripts_ queue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("sentinel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("p",[n("strong",[s._v("初始化master属性")])]),s._v(" "),n("p",[s._v("master实例包括主服务器、从服务器或另一个Sentinel。实例结构如下，了解一下，故障转移的可以先不关注：")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("typedef")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sentinelRedisInstance")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//标识值，记录了实例的类型，以及该实例的当前状态.")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" flags"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//实例的名字.")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//主服务器的名字由用户在配置文件中设置")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//从服务器以及Sentinel 的名字由Sentinel 自动设置")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//格式为ip:port")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//实例的运行ID .")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("runid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//配置纪元，用于实现故障转移")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("uint64_t")]),s._v(" config_epoch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//实例的地址")]),s._v("\n    sentinelAddr "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("addr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// SENTINEL down-after-milliseconds 选项设定的值")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//实例无响应多少毫秒之后才会被判断为主观下线")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("mstime_t")]),s._v(" down_after_period"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//判断这个实例为客观下线所需的支持投票数量")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" quorum"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//在执行故障转移操作时，可以同时对新的主服务器进行同步的从服务器数量")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" paral1el_syncs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//刷新故障迁移状态的最大时限")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("mstime_t")]),s._v(" failover_timeout"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" sentinelRedisInstance"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br")])]),n("p",[n("strong",[s._v("创建连向主服务器的网络连接")])]),s._v(" "),n("p",[s._v("Sentinel会为监视的主服务器创建两个异步网络连接：")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("命令连接")]),s._v("：专用于向主服务器发送命令，接收命令回复。")]),s._v(" "),n("li",[n("strong",[s._v("订阅连接")]),s._v("：专用于订阅主服务器"),n("code",[s._v("__sentinel__:hello")]),s._v("频道。（由于Redis的发布订阅消息不会保存，客户端断线就会丢失，为了不丢失，必须使用专门的频道连接）")])]),s._v(" "),n("h2",{attrs:{id:"获取主从服务器信息"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#获取主从服务器信息"}},[s._v("#")]),s._v(" "),n("strong",[s._v("获取主从服务器信息")])]),s._v(" "),n("p",[s._v("Sentinel默认1"),n("strong",[s._v("0秒一次")]),s._v("通过命令连接被监视的主服务器并发送"),n("strong",[s._v("INFO")]),s._v("命令，获取主服务器信息。主要获取主服务器本身信息（如服务器运行ID），下属从服务器信息（如ip，port，offset）。对应属性进行更新，如果没有某个从服务器新信息就会创建一个实例结构，放到主服务器的slaves字典中，键为ip+端口，值为sentinelRedisInstance。除了创建新实例，还会创建连接到从服务器的"),n("strong",[s._v("命令连接")]),s._v("和"),n("strong",[s._v("订阅连接")]),s._v("。")]),s._v(" "),n("h2",{attrs:{id:"向主服务器和从服务器发送消息"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#向主服务器和从服务器发送消息"}},[s._v("#")]),s._v(" "),n("strong",[s._v("向主服务器和从服务器发送消息")])]),s._v(" "),n("p",[s._v("sentinel默认以两秒一次，向服务器的"),n("code",[s._v("__sentinel__:hello")]),s._v("频道发送消息，命令：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('PUBLISH __sentinel__:hello "<s_ip>,<s_port>,<s_runid>,<s_epoch>,<m_name>,<m_ip>,<m_port>,<m_epoch>"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("参数包含sentinel本身（s_"),n("em",[s._v("...")]),s._v("）和主服务器（m_...）的运行ID，ip，端口号，配置纪元等参数。")]),s._v(" "),n("h2",{attrs:{id:"接收来自主服务器和从服务器的频道信息"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#接收来自主服务器和从服务器的频道信息"}},[s._v("#")]),s._v(" "),n("strong",[s._v("接收来自主服务器和从服务器的频道信息")])]),s._v(" "),n("p",[s._v("Sentinel与一个主服务器或从服务器建立订阅连接后，会发送"),n("code",[s._v("SUBSCRIBE _sentinel_:hello")]),s._v("命令。")]),s._v(" "),n("p",[s._v("也就是Sentinel通过命令连接发送信息到频道，又通过订阅连接接收频道中的信息。一个Sentinel发的信息也会被其他Sentinel接收，根据信息记录的Sentinel运行id和接收信息的Sentinel"),n("strong",[s._v("运行id是否相同")]),s._v("，来决定"),n("strong",[s._v("是否处理")]),s._v("这条消息。通过这种透明的沟通机制，Sentinel可以对各自监听的服务器信息进行更新。")]),s._v(" "),n("h3",{attrs:{id:"更新sentinels字典"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#更新sentinels字典"}},[s._v("#")]),s._v(" "),n("strong",[s._v("更新sentinels字典")])]),s._v(" "),n("p",[s._v("根据接收而来的消息，Sentinel会更新实例结构中sentinels字典保存的所有Sentinel实例的信息。键为Sentinel的ip+端口，值为某个Sentinel的实例。消息接收者会检查发送消息的Sentinel（源sentinel）结构是否在sentinels字典存在则更新，没有则创建实例，和自己相同的sentinel不会被放入。")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("typedef")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sentinelRedisInstance")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    dict "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("sentinels"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("通过这种发布订阅的方式，Sentinel不需要各自发信息告诉对方，而是监视同一个主服务器的多个Sentinel自动发现对方。")]),s._v(" "),n("h3",{attrs:{id:"创建连向其他sentinel的命令连接"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建连向其他sentinel的命令连接"}},[s._v("#")]),s._v(" "),n("strong",[s._v("创建连向其他Sentinel的命令连接")])]),s._v(" "),n("p",[s._v("sentinel也会为对方互相创建命令连接，最终监视同一主服务器的多个sentinel会形成一个"),n("strong",[s._v("网络")]),s._v("。但他们互相之间"),n("strong",[s._v("不会创建订阅连接")]),s._v("，因为他们通过主或从服务器发来的频道来发现未知的sentinel。")]),s._v(" "),n("p",[n("img",{attrs:{src:t(212),alt:"image-20210311165908741"}})]),s._v(" "),n("h3",{attrs:{id:"检测主观下线状态"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#检测主观下线状态"}},[s._v("#")]),s._v(" "),n("strong",[s._v("检测主观下线状态")])]),s._v(" "),n("p",[s._v("Sentinel默认每秒与创建命令连接的实例（主服务器，从服务器，其他sentinel）发送PING命令，通过回复判断是否在线。如果实例返回除了"),n("code",[s._v("+PONG")]),s._v("，"),n("code",[s._v("-LOADING")]),s._v("，"),n("code",[s._v("-MASTERRDOWN")]),s._v("之外的回复或未及时回复，就认为是"),n("strong",[s._v("无效回复")]),s._v("。根据配置文件的"),n("code",[s._v("down-after-milliseconds")]),s._v("指定的"),n("strong",[s._v("主观下线所需时长内")]),s._v("是否一直无效回复，来判断实例是否已经主观下线。下线了就将实例的的flags标识属性打开"),n("code",[s._v("SRI_S_DOWN")]),s._v("标识。由于每个Sentinel中的主观下线时间配置都可以不同，所有有可能"),n("strong",[s._v("某个Sentinel判断主观下线时，另一个Sentinel认为在线状态")]),s._v("。")]),s._v(" "),n("h3",{attrs:{id:"检查客观下线状态"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#检查客观下线状态"}},[s._v("#")]),s._v(" "),n("strong",[s._v("检查客观下线状态")])]),s._v(" "),n("p",[s._v("当Sentinel判断主服务器为主观下线时，还会向其他Sentinel询问，得到足量数据已下线判断后，就会判定服务器为客观下线，并执行故障转移。")]),s._v(" "),n("p",[n("strong",[s._v("发送sentinel is-master-down-by-addr命令")])]),s._v(" "),n("p",[s._v("Sentinel使用："),n("code",[s._v("SENTINEL is-master-down-by-addr <ip> <port> <current. epoch> <runid>")]),s._v("命令询问其他Sentinel是否同意主服务器下线。这些参数分别是Sentinel的ip，端口，配置纪元和运行id。")]),s._v(" "),n("p",[n("strong",[s._v("接收sentinel is-master-down-by-addr命令")])]),s._v(" "),n("p",[s._v("其他接收并返回三个参数的Multi Bulk回复：")]),s._v(" "),n("ol",[n("li",[s._v("<down_state>：是对主服务器的检查结果，1表示已下线；0表示未下线。")]),s._v(" "),n("li",[s._v("<leader_runid>：如果是*，表示该命令用于检测服务器状态；如果是Sentinel的运行id用于选举领头Sentinel。")]),s._v(" "),n("li",[s._v("<leader_epoch>：选举计数器，用于选举领头sentinel。")])]),s._v(" "),n("p",[n("strong",[s._v("接收sentinel is-master-down-by-addr命令的回复")])]),s._v(" "),n("p",[s._v("统计其他Sentinel同意主服务器已下线数量，当数量超过配置值（quorum参数）时，sentinel会将主服务器实例的flags属性的"),n("code",[s._v("SRI_O_DOWN")]),s._v("属性打开，表示已进入客观下线状态。")]),s._v(" "),n("div",{staticClass:"language-c line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("typedef")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sentinelRedisInstance")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//判断这个实例为客观下线所需的支持投票数量")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" quorum"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" sentinelRedisInstance"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h2",{attrs:{id:"选举领头sentinel"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#选举领头sentinel"}},[s._v("#")]),s._v(" "),n("strong",[s._v("选举领头Sentinel")])]),s._v(" "),n("p",[s._v("当主服务器被判断为客观下线时，sentinel会协商选举领头sentinel，并由领头sentinel对下线主服务器执行故障转移操作。")]),s._v(" "),n("p",[s._v("当"),n("code",[s._v("SENTINEL is-master-down-by-addr")]),s._v("命令已经确认主服务器客观下线时，Sentinel还会"),n("strong",[s._v("再发送")]),s._v("带有选举性质的该命令，并且带上自己的运行ID。如果接收命令的Sentinel还没设置局部领头时，就会将这个运行ID作为自己的"),n("strong",[s._v("Multi Bulk回复参数")]),s._v("。根据回复参数来判断多少sentinel将自己设置为局部领头。可能根据网络延迟，有的Sentinel命令比其他Sentinel都先到达，并且胜出（必须有"),n("strong",[s._v("半数以上")]),s._v("的票），那么就由它负责故障转移。一次选举没有产生，一段时间后再次选举，直到选出。")]),s._v(" "),n("h2",{attrs:{id:"故障转移"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#故障转移"}},[s._v("#")]),s._v(" "),n("strong",[s._v("故障转移")])]),s._v(" "),n("p",[s._v("故障转移包括3步：")]),s._v(" "),n("ol",[n("li",[s._v("在已下线的主服务器属下从服务器里选出一个将其转为主服务器。")]),s._v(" "),n("li",[s._v("让其他从服务器都复制新主服务器。")]),s._v(" "),n("li",[s._v("当原来的主服务器再次上线时，让他成为新主服务器的从服务器。")])]),s._v(" "),n("p",[n("strong",[s._v("选出新主服务器")])]),s._v(" "),n("p",[s._v("如何选新的主服务器？Sentinel会将所有从服务器放入列表，"),n("strong",[s._v("一项一项")]),s._v("过滤：")]),s._v(" "),n("ul",[n("li",[s._v("删除处于下线或断线状态的从服务器。")]),s._v(" "),n("li",[s._v("删除最近5秒没有回复过领头"),n("code",[s._v("sentinel INFO")]),s._v("命令的从服务器。")]),s._v(" "),n("li",[s._v("删除与已下线服务器段开时间超过"),n("code",[s._v("down-after-milliseconds*10")]),s._v("毫秒的从服务器。")])]),s._v(" "),n("p",[s._v("然后根据"),n("strong",[s._v("优先级排序")]),s._v("，相同则选"),n("strong",[s._v("偏移量最大")]),s._v("的，相同则选运行ID最小的。")]),s._v(" "),n("p",[s._v("选出来之后，对这个从服务器发送"),n("code",[s._v("SLAVEOF no one")]),s._v("命令，然后以"),n("strong",[s._v("每秒一次")]),s._v("的频率向它发送"),n("code",[s._v("INFO")]),s._v("命令，观察返回的role属性如果变成master，就表示顺利升级为主服务器了。")]),s._v(" "),n("p",[n("strong",[s._v("修改从服务器的复制目标")])]),s._v(" "),n("p",[s._v("向所有其他从服务器发送"),n("code",[s._v("SLAVEOF")]),s._v("命令，让他们都去复制新的主服务器。")]),s._v(" "),n("p",[n("strong",[s._v("将旧的主服务器变为从服务器")])]),s._v(" "),n("p",[s._v("当原来的主服务器上线时，Sentinel就会向它发送"),n("code",[s._v("SLAVEOF")]),s._v("命令，让他成为新主服务器的从服务器。")]),s._v(" "),n("blockquote",[n("p",[s._v("参考文章")])]),s._v(" "),n("ul",[n("li",[s._v("https://zhuanlan.zhihu.com/p/143634281")])])])}],a=t(0),_=Object(a.a)({},(function(){this._self._c;return this._m(0)}),e,!1,null,null,null);n.default=_.exports}}]);