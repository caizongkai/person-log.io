(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{213:function(t,s,n){t.exports=n.p+"assets/img/image-20210308093407525.023df9ca.png"},214:function(t,s,n){t.exports=n.p+"assets/img/image-20210308093449093.4c1cc0de.png"},215:function(t,s,n){t.exports=n.p+"assets/img/image-20210308094117208.fa70ac8b.png"},216:function(t,s,n){t.exports=n.p+"assets/img/image-20210308094314138.bf1959ae.png"},314:function(t,s,n){"use strict";n.r(s);var r=[function(){var t=this._self._c;return t("h1",{attrs:{id:"数据库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据库"}},[this._v("#")]),this._v(" 数据库")])},function(){var t=this._self._c;return t("h2",{attrs:{id:"服务器中的数据库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#服务器中的数据库"}},[this._v("#")]),this._v(" 服务器中的数据库")])},function(){var t=this._self._c;return t("p",[this._v("Redis把所有库信息都保存在"),t("code",[this._v("redis.h/redisServer")]),this._v("结构的db数组中，数组类型是"),t("code",[this._v("redis.h/redisDB")]),this._v("，dbnum决定着应该创建多少数据库中的db，clients维护着所有连接Redis的客户端：")])},function(){var t=this,s=t._self._c;return s("div",{staticClass:"language-cpp line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-cpp"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("redisServer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//服务器的数据库数量")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" dbnum"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//一个数组，保存着服务器中的所有数据库")]),t._v("\n    redisDb "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//客户端状态链表")]),t._v("\n    list "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("clients"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//...")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br")])])},function(){var t=this._self._c;return t("p",[t("img",{attrs:{src:n(213),alt:"image-20210308093407525"}})])},function(){var t=this._self._c;return t("p",[this._v("当切换库时，其实就是redisClient.db对redisServer.db数组的目标数据库指针的移动。下面展示了从0号库切为1号库的过程。通过"),t("strong",[this._v("指针的切换")]),this._v("，实现对库的共享：")])},function(){var t=this._self._c;return t("p",[t("img",{attrs:{src:n(214),alt:"image-20210308093449093"}})])},function(){var t=this._self._c;return t("h2",{attrs:{id:"数据库的键空间"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据库的键空间"}},[this._v("#")]),this._v(" 数据库的键空间")])},function(){var t=this._self._c;return t("p",[this._v("redis将所有key进行统一管理，按照所属的库划分，放在redisDb的字典中（按照上面画的数据结构，redis每一个库都对应一个redisDb）。redisDb结构的dict字典保存了该数据库中的所有键值对，也称为"),t("strong",[this._v("键空间")]),this._v("。键空间的数据结构如下：")])},function(){var t=this,s=t._self._c;return s("div",{staticClass:"language-cpp line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-cpp"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("redisDb")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//数据库键空间，保存着数据库中的所有键值对")]),t._v("\n    dict "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("dict"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])])},function(){var t=this._self._c;return t("h2",{attrs:{id:"键过期时间相关操作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#键过期时间相关操作"}},[this._v("#")]),this._v(" 键过期时间相关操作")])},function(){var t=this,s=t._self._c;return s("p",[t._v("通过"),s("code",[t._v("EXPIRE")]),t._v("或"),s("code",[t._v("PEXPIRE")]),t._v("，客户端可以以"),s("strong",[t._v("秒或毫秒")]),t._v("为精度设置过期时间（Time To Live，TTL）。通过"),s("code",[t._v("EXPIREAT")]),t._v("或"),s("code",[t._v("PEXPIREAT")]),t._v("，客户端可以设置"),s("strong",[t._v("时间戳")]),t._v("作为过期时间。")])},function(){var t=this._self._c;return t("h3",{attrs:{id:"设置过期时间"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#设置过期时间"}},[this._v("#")]),this._v(" "),t("strong",[this._v("设置过期时间")])])},function(){var t=this._self._c;return t("p",[this._v("其实几个命令底层都是经过换算后，用"),t("strong",[this._v("PEXPIREAT")]),this._v("实现的。")])},function(){var t=this._self._c;return t("p",[t("img",{attrs:{src:n(215),alt:"image-20210308094117208"}})])},function(){var t=this._self._c;return t("h3",{attrs:{id:"存储过期时间"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#存储过期时间"}},[this._v("#")]),this._v(" "),t("strong",[this._v("存储过期时间")])])},function(){var t=this._self._c;return t("p",[this._v("redisDb中有一个expires的字典数据结构保存所有键的过期时间，也称为过期字典。过期字典的值是一个"),t("strong",[this._v("long long")]),this._v("类型的整数，保存了键所指向的数据库键的过期时间（毫秒精度的Unix时间戳）。")])},function(){var t=this,s=t._self._c;return s("div",{staticClass:"language-cpp line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-cpp"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("redisDb")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//过期字典，保存着键的过期时间")]),t._v("\n    dict "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("expires"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" redisDb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])])},function(){var t=this._self._c;return t("p",[t("img",{attrs:{src:n(216),alt:"image-20210308094314138"}})])},function(){var t=this._self._c;return t("h3",{attrs:{id:"移除过期时间"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#移除过期时间"}},[this._v("#")]),this._v(" "),t("strong",[this._v("移除过期时间")])])},function(){var t=this._self._c;return t("p",[this._v("PERSIST命令可以"),t("strong",[this._v("移除一个键的过期时间")]),this._v("，在过期字段中查找给定键，并"),t("strong",[this._v("解除")]),this._v("键和值在过期字典中的关联。")])},function(){var t=this._self._c;return t("h3",{attrs:{id:"计算并返回剩余生存时间"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#计算并返回剩余生存时间"}},[this._v("#")]),this._v(" "),t("strong",[this._v("计算并返回剩余生存时间")])])},function(){var t=this._self._c;return t("h3",{attrs:{id:"过期键删除策略"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#过期键删除策略"}},[this._v("#")]),this._v(" "),t("strong",[this._v("过期键删除策略")])])},function(){var t=this._self._c;return t("ul",[t("li",[t("p",[this._v("定时删除：设置键的过期时间时，创建定时器，过期时，以定时器立刻执行键的删除。")])]),this._v(" "),t("li",[t("p",[this._v("惰性删除：不着急删除过期键，每次获取时都会进行过期校验。")])]),this._v(" "),t("li",[t("p",[this._v("定期删除：隔一段时间，程序就对数据库检查，删除过期键。")])])])},function(){var t=this._self._c;return t("p",[t("strong",[this._v("定时删除")])])},function(){var t=this._self._c;return t("p",[this._v("定时删除策略"),t("strong",[this._v("对内存友好")]),this._v("，但"),t("strong",[this._v("对CPU不友好")]),this._v("。过期键比较多时，删除会占用资源，特别是和删除当前任务无关的过期键，影响性能。Redis定时器需要创建时间事件，时间事件底层由无需链表实现，查找复杂度为O(N)，如果需要高效处理必然要创建大量的定时器，并不现实。")])},function(){var t=this._self._c;return t("p",[t("strong",[this._v("惰性删除")])])},function(){var t=this._self._c;return t("p",[this._v("惰性删除"),t("strong",[this._v("对CPU友好")]),this._v("，但"),t("strong",[this._v("对内存不友好")]),this._v("。不需要把时间浪费在非相关键的删除上。当键非常多时，会导致内存泄漏，因为只有用到时才会判断，删除。")])},function(){var t=this._self._c;return t("p",[t("strong",[this._v("定期删除")])])},function(){var t=this._self._c;return t("p",[this._v("定期删除是一种折衷的方式，隔一段时间执行一次，并"),t("strong",[this._v("限制")]),this._v("删除操作"),t("strong",[this._v("执行的时长和频率")]),this._v("减少对CPU的占用；定期删除还能"),t("strong",[this._v("减少庞大的过期键对内存的占用")]),this._v("。如何确定时长和频率是难点，过长或过少，会退变为定时删除和惰性删除。")])},function(){var t=this._self._c;return t("h3",{attrs:{id:"redis的过期键删除策略"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis的过期键删除策略"}},[this._v("#")]),this._v(" "),t("strong",[this._v("Redis的过期键删除策略")])])},function(){var t=this._self._c;return t("p",[this._v("Redis使用了"),t("strong",[this._v("惰性删除和定期删除")]),this._v("两种策略配合，服务器可以合理地在使用CPU时间和避免内存浪费之间权衡。")])},function(){var t=this._self._c;return t("ul",[t("li",[this._v("惰性删除策略的实现")])])},function(){var t=this._self._c;return t("p",[this._v("该策略由"),t("code",[this._v("db.c/expireIfNeeded")]),this._v("函数实现，如同指令过滤器，在执行读写键指令时都会调用该函数检查，如果过期则删除。")])},function(){var t=this._self._c;return t("ul",[t("li",[this._v("定期删除策略的实现")])])},function(){var t=this,s=t._self._c;return s("p",[t._v("该策略由"),s("code",[t._v("redis.c/activeExpireCycle")]),t._v("函数实现，当服务器周期性调用"),s("code",[t._v("redis.c/serverCron")]),t._v("函数时，"),s("code",[t._v("activeExpireCycle")]),t._v("函数就会被调用，规定时间内，多次遍历服务器的各个数据库，从expires字典中随机检查一部分键的过期时间，并删除过期键。"),s("code",[t._v("activeExpireCycle")]),t._v("函数的主要工作可以拆分为：")])},function(){var t=this,s=t._self._c;return s("ol",[s("li",[t._v("每次运行，都从一定数量的数据库中取出一定数量的"),s("strong",[t._v("随机键")]),t._v("检查并删除过期键。")]),t._v(" "),s("li",[t._v("全局遍历记录检查进度，有"),s("strong",[t._v("记忆")]),t._v("功能，全局变量存储的是几号库。")]),t._v(" "),s("li",[t._v("当所有数据库都被检查一遍后，"),s("strong",[t._v("重置")]),t._v("全局变量，进行新一轮检查。")])])},function(){var t=this._self._c;return t("p",[t("strong",[this._v("发送通知")])])},function(){var t=this._self._c;return t("p",[this._v("该功能由"),t("code",[this._v("notify.c/notifyKeyspaceEvent")]),this._v("函数实现：")])},function(){var t=this._self._c;return t("p",[t("strong",[this._v("发送通知的实现")])])},function(){var t=this._self._c;return t("ol",[t("li",[this._v("通过服务器配置的值判断，如果给定通知类型不是服务器允许的就直接返回。")]),this._v(" "),t("li",[this._v("如果是服务器允许发送的，检测是否允许发送键空间通知，允许则构建发送事件并通知。")]),this._v(" "),t("li",[this._v("检测是否允许发送键事件通知，如果允许则构建并发送通知。")])])},function(){var t=this._self._c;return t("blockquote",[t("p",[this._v("参考文章")])])},function(){var t=this._self._c;return t("ul",[t("li",[this._v("https://zhuanlan.zhihu.com/p/142591479")])])}],_=n(0),e=Object(_.a)({},(function(){var t=this,s=t._self._c;return s("div",{staticClass:"content"},[t._m(0),t._v(" "),s("p",[t._v("从Redis服务端的实现角度介绍，包括db存储，切换，键的存储及过期相关处理。")]),t._v(" "),t._m(1),t._v(" "),t._m(2),t._v(" "),t._m(3),s("p",[t._v("服务器数据库实例如图所示：")]),t._v(" "),t._m(4),t._v(" "),t._m(5),t._v(" "),t._m(6),t._v(" "),t._m(7),t._v(" "),t._m(8),t._v(" "),t._m(9),s("p",[t._v("键空间的键就是数据库的键，每个键都是一个字符串对象，键空间的值就是字符串对象，列表对象，哈希表对象，集合对象和有序集合对象。")]),t._v(" "),t._m(10),t._v(" "),t._m(11),t._v(" "),t._m(12),t._v(" "),s("p",[t._v("Redis提供了4个命令设置过期时间：")]),t._v(" "),s("ul",[s("li",[t._v("EXPIRE"),s("key",[s("ttl",[t._v("：将key的生存时间设为ttl秒。")])],1)],1),t._v(" "),s("li",[t._v("PEXPIRE"),s("key",[s("ttl",[t._v("：将key的生存时间设为ttl毫秒。")])],1)],1),t._v(" "),s("li",[t._v("EXPIREAT"),s("key",[s("timestamp",[t._v("：将key的过期时间设置为timestamp秒数时间戳。")])],1)],1),t._v(" "),s("li",[t._v("PEXPIREAT"),s("key",[s("timestamp",[t._v("：将key的过期时间设置为timestamp毫秒数时间戳。")])],1)],1)]),t._v(" "),t._m(13),t._v(" "),s("p",[t._v("实现转换关系图：")]),t._v(" "),t._m(14),t._v(" "),t._m(15),t._v(" "),t._m(16),t._v(" "),t._m(17),t._m(18),t._v(" "),t._m(19),t._v(" "),t._m(20),t._v(" "),t._m(21),t._v(" "),s("p",[t._v("TTL以秒为单位返回剩余时间，PTTL以毫秒返回键的剩余时间。二者的计算都是通过计算键的过期时间与当前时间之差来实现的。")]),t._v(" "),t._m(22),t._v(" "),s("p",[t._v("如果一个键过期了，那么在什么时候被删除？列举几个常见淘汰策略：")]),t._v(" "),t._m(23),t._v(" "),t._m(24),t._v(" "),t._m(25),t._v(" "),t._m(26),t._v(" "),t._m(27),t._v(" "),t._m(28),t._v(" "),t._m(29),t._v(" "),t._m(30),t._v(" "),t._m(31),t._v(" "),t._m(32),t._v(" "),t._m(33),t._v(" "),t._m(34),t._v(" "),t._m(35),t._v(" "),t._m(36),t._v(" "),t._m(37),t._v(" "),t._m(38),t._v(" "),s("p",[t._v("通过几个入参：要发送的通知类型，时间名称，产生时间的键，产生时间的数据库号。来构造事件通知内容和接收频道名，Redis许多指令的执行函数都会调用这个函数，传递该命令引发的事件相关信息。")]),t._v(" "),t._m(39),t._v(" "),t._m(40),t._v(" "),t._m(41),t._v(" "),t._m(42)])}),r,!1,null,null,null);s.default=e.exports}}]);