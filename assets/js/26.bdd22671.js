(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{209:function(_,v,s){_.exports=s.p+"assets/img/image-20210311130658607.9596e886.png"},316:function(_,v,s){"use strict";s.r(v);var t=[function(){var _=this,v=_._self._c;return v("div",{staticClass:"content"},[v("h1",{attrs:{id:"主从复制"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#主从复制"}},[_._v("#")]),_._v(" 主从复制")]),_._v(" "),v("h2",{attrs:{id:"一、复制"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#一、复制"}},[_._v("#")]),_._v(" "),v("strong",[_._v("一、复制")])]),_._v(" "),v("p",[_._v("在Redis中，可通过SLAVEOF命令或配置文件中设置slaveof选项，让一个服务器去复制另一个服务器，被复制的为主服务器，对其复制的称为从服务器。")]),_._v(" "),v("h3",{attrs:{id:"_1-1-旧版本复制功能的实现"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-旧版本复制功能的实现"}},[_._v("#")]),_._v(" "),v("strong",[_._v("1.1 旧版本复制功能的实现")])]),_._v(" "),v("p",[_._v("Redis在2.8以前使用旧版本复制，在短线重连后的从服务器会遇上低效的情况。")]),_._v(" "),v("p",[_._v("Redis的复制功能分为"),v("strong",[_._v("同步")]),_._v("和"),v("strong",[_._v("命令传播")]),_._v("俩操作：")]),_._v(" "),v("ul",[v("li",[_._v("同步用于把从服务器的数据库状态"),v("strong",[_._v("更新至主服务器的数据库状态")]),_._v("。")]),_._v(" "),v("li",[_._v("命令传播是在主服务器的"),v("strong",[_._v("数据库状态被修改")]),_._v("时，导致主从数据库状态不一致时，让主从回到一致的过程。")])]),_._v(" "),v("p",[v("strong",[_._v("同步")])]),_._v(" "),v("p",[_._v("从服务器对主服务器的同步（下文以主从代替），需要向主服务器发送SYNC命令，具体步骤：")]),_._v(" "),v("ol",[v("li",[_._v("从向主发送SYNC命令。")]),_._v(" "),v("li",[_._v("主接收并"),v("strong",[_._v("执行BGSAVE")]),_._v("，后台生成RDB文件，并用一个"),v("strong",[_._v("缓冲区记录")]),_._v("现在开始执行的所有写命令。")]),_._v(" "),v("li",[_._v("BGSAVE执行完毕时，主将RDB文件发给从，从接收并载入，更新数据库状态。")]),_._v(" "),v("li",[_._v("主将其记录在"),v("strong",[_._v("缓冲区的所有写命令")]),_._v("发给从，从执行写命令。")])]),_._v(" "),v("p",[v("strong",[_._v("命令传播")])]),_._v(" "),v("p",[_._v("当主发生写操作时，主从同步需要通过命令传播，具体步骤：")]),_._v(" "),v("ol",[v("li",[_._v("主将写命令发送给从。")]),_._v(" "),v("li",[_._v("从接收并执行相同的写命令。")])]),_._v(" "),v("h3",{attrs:{id:"_1-2-旧版复制功能的缺陷"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-旧版复制功能的缺陷"}},[_._v("#")]),_._v(" "),v("strong",[_._v("1.2 旧版复制功能的缺陷")])]),_._v(" "),v("p",[_._v("旧版复制的缺陷主要体现在断线重连上，主因为网络原因中断复制，但从通过自动重连连上主，并继续复制主的时候。此时，从发送SYNC命令，希望将"),v("strong",[_._v("断线期间")]),_._v("由于写操作对主的数据库状态修改同步，但SYNC每次都会"),v("strong",[_._v("重新生成RDB文件")]),_._v("，将"),v("strong",[_._v("所有的")]),_._v("数据库状态都写到RDB，这就造成了资源的"),v("strong",[_._v("大量浪费")]),_._v("。SYNC命令对性能的损耗比较高主要表现在：")]),_._v(" "),v("ol",[v("li",[_._v("主执行BGSAVE生成RDB文件会消耗"),v("strong",[_._v("CPU、内存和磁盘I/O资源")]),_._v("。")]),_._v(" "),v("li",[_._v("主需要发送RDB，消耗"),v("strong",[_._v("网络资源")]),_._v("。")]),_._v(" "),v("li",[_._v("从接收并载入RDB，载入期间是"),v("strong",[_._v("阻塞的无法处理命令")]),_._v("。")])]),_._v(" "),v("p",[_._v("因此，必须是真正有必要才调用SYNC命令。")]),_._v(" "),v("h3",{attrs:{id:"_1-3-新版复制功能的实现"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-新版复制功能的实现"}},[_._v("#")]),_._v(" "),v("strong",[_._v("1.3 新版复制功能的实现")])]),_._v(" "),v("p",[_._v("Redis从2.8开始使用PSYNC代替SYNC命令来执行同步操作。")]),_._v(" "),v("p",[_._v("PSYNC有完整重同步和部分重同步的两种模式：")]),_._v(" "),v("ul",[v("li",[_._v("完整重同步用于初次复制的情况，与SYNC命令一样。")]),_._v(" "),v("li",[_._v("部分重同步用于处理断线重连后的情况，重连后，主服务器将"),v("strong",[_._v("断线期间执行的写命令")]),_._v("发送给从服务器，从只需接收并执行这些命令。")])]),_._v(" "),v("p",[_._v("部分重同步的执行过程：")]),_._v(" "),v("ol",[v("li",[_._v("从向主发送PSYNC命令，请求同步数据。")]),_._v(" "),v("li",[_._v("主判断后，确认需要执行部分重同步时，返回给从**+COUNTINUE**。")]),_._v(" "),v("li",[_._v("主将断线期间的写命令发送给从。")])]),_._v(" "),v("h3",{attrs:{id:"_1-4-部分重同步的实现"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-部分重同步的实现"}},[_._v("#")]),_._v(" "),v("strong",[_._v("1.4 部分重同步的实现")])]),_._v(" "),v("p",[_._v("部分重同步基于三个部分实现：")]),_._v(" "),v("ul",[v("li",[_._v("主从服务器的复制偏移量")]),_._v(" "),v("li",[_._v("主服务器的复制积压缓冲区")]),_._v(" "),v("li",[_._v("服务器运行ID")])]),_._v(" "),v("p",[v("strong",[_._v("复制偏移量")])]),_._v(" "),v("p",[_._v("主从都会维护一个复制偏移量，记录"),v("strong",[_._v("存储数据的字节数")]),_._v("，当主服务器向从服务器传播N个字节数据时，主的复制偏移量会加N，从接收到之后也会加N。通过偏移量"),v("strong",[_._v("判断数据库状态是否一致")]),_._v("。但有一个问题，就是从服务器重连后，需要执行部分还是完整重同步，这时候就需要复制积压缓冲区来帮忙判断。")]),_._v(" "),v("p",[v("strong",[_._v("复制积压缓冲区")])]),_._v(" "),v("p",[_._v("复制积压缓冲区由主服务器维护，是固定长度的"),v("strong",[_._v("先进先出队列")]),_._v("，默认1M。当入队元素大于队列长度时，最先入队的元素会被弹出。主服务器在命令传播时，不仅将写命令发给从，还会将"),v("strong",[_._v("写命令入队至积压缓冲区")]),_._v("。")]),_._v(" "),v("p",[_._v("复制积压缓冲区会保存最近写的命令，并为队列中的"),v("strong",[_._v("每个字节记录复制偏移量")]),_._v("。")]),_._v(" "),v("p",[_._v("当从服务器重连后，发送PSYNC并将自己的复制偏移量也发送给主服务器，主服务器拿着复制偏移量去复制积压缓冲区找，如果"),v("strong",[_._v("存在")]),_._v("则进行部分重同步并给从服务器"),v("strong",[_._v("发送+CONTINUE")]),_._v("回复，否则进行完整重同步。")]),_._v(" "),v("p",[_._v("复制积压缓冲区大小应该根据实际场景的两个因素进行调整：")]),_._v(" "),v("ul",[v("li",[_._v("断线重连平均时间")]),_._v(" "),v("li",[_._v("主服务器平均每秒产生写命令的数据量")])]),_._v(" "),v("p",[_._v("一般得将这两个指标相乘后再乘以2，作为复制积压缓冲区的大小，应对大多数断线情况。")]),_._v(" "),v("p",[v("strong",[_._v("服务器运行ID")])]),_._v(" "),v("p",[_._v("服务器运行ID决定断线后执行哪种同步方式，主从都有运行ID，是自动生成的40个随机十六进制字符。主从第一次复制时，从服务器会保存主服务器的ID，断线后也会向主服务器发送这个ID，如果"),v("strong",[_._v("不同则进行完整重同步")]),_._v("（之前的主服务器由于某些原因连接断开，重新选举的情况）；相同则部分重同步。")]),_._v(" "),v("h3",{attrs:{id:"_1-5-psync命令的实现"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-psync命令的实现"}},[_._v("#")]),_._v(" "),v("strong",[_._v("1.5 PSYNC命令的实现")])]),_._v(" "),v("p",[_._v("PSYNC命令调用方法有两种：")]),_._v(" "),v("ul",[v("li",[_._v("从服务器第一次复制时，会发送"),v("code",[_._v("**PSYNC ? -1**")]),_._v("命令，请求完整重同步。")]),_._v(" "),v("li",[_._v("已经复制过的情况，向主服务器发送"),v("code",[_._v("**PSYNC <runid> <offset>**")]),_._v("命令，一个是主服务器运行ID，一个是积压缓冲区的偏移量。")])]),_._v(" "),v("p",[_._v("主服务器接收后有3种返回值：")]),_._v(" "),v("ul",[v("li",[v("code",[_._v("+FULLRESYNC <runid> <offset>")]),_._v("：表示执行"),v("strong",[_._v("完整重同步")]),_._v("，从服务器会将这两个变量保存。")]),_._v(" "),v("li",[v("code",[_._v("+CONTINUE")]),_._v("：执行"),v("strong",[_._v("部分重同步")]),_._v("，从服务器等待缺失数据的发送。")]),_._v(" "),v("li",[v("code",[_._v("-ERR")]),_._v("：主服务器版本低于2.8，执行"),v("strong",[_._v("完整重同步")]),_._v("操作。")])]),_._v(" "),v("p",[v("img",{attrs:{src:s(209),alt:"image-20210311130658607"}})]),_._v(" "),v("h3",{attrs:{id:"_1-6-一次完整的主从复制过程"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_1-6-一次完整的主从复制过程"}},[_._v("#")]),_._v(" "),v("strong",[_._v("1.6 一次完整的主从复制过程")])]),_._v(" "),v("p",[_._v("一次完整的复制过程可以分为设置主服务器的地址和端口、建立套接字连接、发送PING命令、身份验证、发送端口信息、同步、命令传播。")]),_._v(" "),v("p",[v("strong",[_._v("设置主服务器的地址和端口")])]),_._v(" "),v("p",[_._v("当客户端向服务器发送SLAVEOF命令时，从服务器会将主服务器的ip和端口都保存后发送OK。这是一个"),v("strong",[_._v("异步命令")]),_._v("，所以复制工作在回复OK后再执行。")]),_._v(" "),v("p",[v("strong",[_._v("建立套接字连接")])]),_._v(" "),v("p",[_._v("从服务器此时创建连接主服务器的套接字，如果套接字能成功连接，从服务器会给它关联一个处理复制工作的"),v("strong",[_._v("文件事件处理器")]),_._v("（负责接收RDB，传播的命令等）。主从成功连接后，主服务器会创建从服务器的客户端状态。")]),_._v(" "),v("p",[v("strong",[_._v("发送PING命令")])]),_._v(" "),v("p",[_._v("从服务器在套接字连接后做的第一个工作就是发送PING命令，检查套接字"),v("strong",[_._v("读写状态是否正常")]),_._v("；主服务器"),v("strong",[_._v("能否正常处理命令请求")]),_._v("。而主服务器会根据网络状态、能够处理给出对应回复。一旦回复超时或返回错误，从服务器就会断开并重连主服务器。")]),_._v(" "),v("p",[v("strong",[_._v("身份验证")])]),_._v(" "),v("p",[_._v("检查从服务器是否设置masterauth，如果设置则进行身份验证。")]),_._v(" "),v("p",[v("strong",[_._v("发送端口信息")])]),_._v(" "),v("p",[_._v("身份验证后，从服务器向主服务器发送自己监听的端口号，主服务器保存这个端口号。")]),_._v(" "),v("p",[v("strong",[_._v("同步")])]),_._v(" "),v("p",[_._v("从服务器发送PSYNC命令，主从互相成为对方的客户端，都能够执行命令并回复，执行同步操作，看是完整重同步还是部分重同步。")]),_._v(" "),v("p",[v("strong",[_._v("命令传播")])]),_._v(" "),v("p",[_._v("完成同步后，进入该阶段，主服务器将写命令发送给从服务器，从服务器接收并执行。")]),_._v(" "),v("h3",{attrs:{id:"_1-7-心跳检测"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_1-7-心跳检测"}},[_._v("#")]),_._v(" "),v("strong",[_._v("1.7 心跳检测")])]),_._v(" "),v("p",[_._v("在命令传播阶段，从服务器默认"),v("strong",[_._v("1秒一次")]),_._v("发送"),v("code",[_._v("REPLCONF ACK <replication_offset>")]),_._v("命令给主服务器，replication_offset是复制偏移量。这么做有3个作用：")]),_._v(" "),v("ul",[v("li",[_._v("检测主从网络状态")]),_._v(" "),v("li",[_._v("辅助实现min-slave选项")]),_._v(" "),v("li",[_._v("检测命令丢失")])]),_._v(" "),v("p",[v("strong",[_._v("检测主从网络状态")])]),_._v(" "),v("p",[_._v("下面分别说这三个作用。检测网络连接很好理解，如果主服务器超过一秒没受到从服务器的"),v("code",[_._v("REPLCONF ACK")]),_._v("则表示连接有问题。")]),_._v(" "),v("p",[v("strong",[_._v("辅助实现min-slave选项")])]),_._v(" "),v("p",[_._v("Redis的"),v("code",[_._v("min-slaves-to-write")]),_._v("和"),v("code",[_._v("min-slaves-max-lag")]),_._v("可"),v("strong",[_._v("防止主服务器在不安全的情况下执行写命令")]),_._v("。如果设置如下：")]),_._v(" "),v("div",{staticClass:"language-text line-numbers-mode"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[_._v("min-slaves-to-write 3 \nmin-slaves-max-lag 10\n")])]),_._v(" "),v("div",{staticClass:"line-numbers-wrapper"},[v("span",{staticClass:"line-number"},[_._v("1")]),v("br"),v("span",{staticClass:"line-number"},[_._v("2")]),v("br")])]),v("p",[_._v("表示从服务器数量少于3或3个从服务器延迟大于等于10s时，主服务器拒绝写命令。")]),_._v(" "),v("p",[v("strong",[_._v("检测命令丢失")])]),_._v(" "),v("p",[_._v("通过发送的偏移量，主服务器会判断命令是否有丢失，如果丢失，就从积压缓冲区里找到并"),v("strong",[_._v("补发")]),_._v("。")]),_._v(" "),v("p",[_._v("注：Redis2.8之前版本并"),v("strong",[_._v("不会注意")]),_._v("到丢失数据，所以保持主从数据一致性最好使用以上版本。")])])}],r=s(0),n=Object(r.a)({},(function(){this._self._c;return this._m(0)}),t,!1,null,null,null);v.default=n.exports}}]);